---
- name: Download and install Amster
  include: amster.yml

- block:
    - name: Create Amster scripts
      template:
        src: "{{ item }}.j2"
        dest: "{{ amster_home_version }}/{{ item }}.amster"
        owner: "{{ amster_owner }}"
        group: "{{ amster_group }}"
        mode: 0600
      with_items: "{{ am_amster_scripts_default + am_amster_subscripts }}"

    - name: Install AM
      include: install.yml

    - include: git_repos.yml
      when: am_git_config is defined

    - name: Configure AM
      include: configure.yml

    - name: Certificate AM
      include: certificate.yml
      with_items: "{{ am_certificate }}"
      when: am_certificate is defined

    - name: Replace AM keystore
      include: keystore.yml
      when: am_keystore is defined

  when: amster_am_install is defined

- name: Fail manual mode
  fail:
    msg: "Running in manual configure mode!"
  when: am_configure_manual|default(False)

- name: "AM Security Advisory #202104"
  ansible.builtin.replace:
    path: "{{ tomcat_home_link|default('/opt/tomcat/tomcat')}}/webapps/{{ am_context }}/WEB-INF/web.xml"
    #regexp: '(?:<servlet-mapping){1}.*?VersionServlet.*?(?:<\/servlet-mapping>){1}'
    regexp: '(?:<!--)?(?:<servlet-mapping){1}.*?\n{1}.*?VersionServlet.*\n.*\n.*(?:</servlet-mapping>){1}(?:-->)?\n'
    replace: "{{ am_security_advisory_202104|indent(4) }}"
