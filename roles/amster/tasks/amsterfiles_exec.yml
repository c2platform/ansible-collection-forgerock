---

- name: Get cot.json in place
  file:
    dest:  "{{ amster_home }}/{{ amster_home|basename }}-{{ amster_version }}/amster_config/federation/cot.json"
    owner: "{{ am_owner }}"
    group: "{{ am_group }}"
    mode: 0644
    remote_src: yes
    src: "{{ amster_code_location }}/cot.json"

- name: Stat openamcfg dir  (in /opt/am, not /opt/amster!) to prevent running twice
  stat:
    path: "{{ am_home }}/{{ am_version }}/openamcfg"
  register: amster_has_run

# To be replaced by running an export_stat.amster script and then inspecting its output for proper content
# However ' proper'  will be known later, it's the setup after the 20+ good Amster files
# Maybe we can first dummuy with old config.amster, otherwise the wrong stat stays for soome time....

- name: Create config.amster script file
  template:
    src: config.amster.j2
    dest: "{{ amster_home }}/{{ amster_home|basename }}-{{ amster_version }}/config.amster"
    owner: "{{ am_owner }}"
    group: "{{ am_group }}"
    mode: 0755
# Note that we preferred having config.amster in a muli-line readable format with \ concatenation, but even without Ansible
# this proved too buggy in Amster 6.5. Hence the looooong line :-(
# Also note that --cookieDomain  is for now hardcoded to the  DNS name of the AM machine. That is not the proper way
# for post-MVP but the whole .amster file logistics change then, with part input from BKWI git (file which are part of a CI-CD Java release)
# Hence we left out making an extra Ansible variable for it.

- name: Confirm AM up
  uri:
    url: "http://{{ amster_install_am['serverURL']  }}:8080/am"
    status_code: 200
  register: am_up_result
  until: am_up_result.status == 200
  retries: 10
  delay: 10 # seconds
  when: not amster_has_run.stat.exists
#  This is a waitloop until AM web interface, assumed needed for the Amster REST calls, is up and running


- name: check ldap connection to ds (check is more or less a random one from within ds role)
# The actual check on the result is in the 'when' clause for the ldap tool, see below.
# Last parameter is dashless hence hardcoded here.
  shell:  "./ldapsearch  {{ dsc_user_reports_inquire|c2platform.forgerock.ds_cmd }} objectclass=person"
  become: yes
  become_user: tomcat
  args:
    chdir: "{{ ds_home }}/{{ ds_home|basename }}-{{ ds_version }}/bin"
  register: user_reports_inquire
  ignore_errors: yes

- name: Exit if no running DS service found
  when: not user_reports_inquire is search("Service Account")
  fail: msg="The DS server needed to provision using Amster is not running"


- name: execute amster if not yet done
  command: "./amster config.amster"
  register: task_register_var
  become: yes
  become_user: "{{ am_owner }}"
  args:
    chdir: "{{ amster_home }}/{{ amster_home|basename }}-{{ amster_version }}/"
  when: not amster_has_run.stat.exists

- name: debug task_register_var
  debug:
    msg: "{{ task_register_var }}"
