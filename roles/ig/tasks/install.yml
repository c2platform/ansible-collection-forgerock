---
# Install IG 
# Assumes tomcat instance has been previously deployed, which is done in suwinet_ig play
# Pass tomcat_instance_dir as a role param


- name: Create owner
  user:
    name: "{{ ig_owner }}"
    shell: /bin/bash
    system: true

- name: Create home
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ig_owner }}"
    group: "{{ ig_group }}"
    mode: 0755
  with_items:
    - "{{ ig_home }}"
    - "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}"
    - "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig"
    - "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/config"
    - "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/config/routes"
    - "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/scripts"
    - "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/scripts/groovy"


# As for chmod rights, Chef/XLS has a mixture of 700-becoming-755, 500 and 644. We'll try with this
# highest/unsafest level first, if any tool requires a lower/safer level we'll adjust.


- name: Download OpenIG war
  get_url:
    url: "{{ ig_versions[ig_version]['url'] }}"
    dest: "{{ tomcat_instance_dir }}/ig.war"
    mode: "755"

# in case it is already running...
- name: Stop IG
  service: name="{{ ig_service }}" state=stopped

# Remove the ROOT dir so we can install the gateway at the root

- name: Remove ROOT
  file: path="{{ tomcat_home_version }}/webapps/ROOT.war" state=absent
# create fresh

- name: Copy the gateway war file as ROOT.war (unpacking is done by Tomcat automatically)
  copy:
    src: "{{ tomcat_instance_dir }}/ig.war"
    dest: "{{ tomcat_home_version }}/webapps/ROOT.war"
    remote_src: yes


- name: restart tomcat
  service: name="{{ ig_service }}" state=restarted

- name: Get templated configs in place
  template:
    src: "{{ item }}.json.j2"
    dest:  "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/config/{{ item }}.json"
    owner: "{{ ig_owner  }}"
    group: "{{ ig_group }}"
    mode: 0755
  with_items:
    - config
    - properties

- name: Get templated routes in place
  template:
    src: "{{ item }}.json.j2"
    dest:  "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/config/routes/{{ item }}.json"
    owner: "{{ ig_owner  }}"
    group: "{{ ig_group }}"
    mode: 0755
  with_items:
    - 111-not_enforced
    - 112-local_static_content
    - 121-ipwhitelisting-template
    - 202-suwinet-inkijk-pep
    - 900_not_found

- name: Get groovy script(s) in place
  copy:
    dest:  "{{ ig_home }}/{{ ig_home|basename }}-{{ ig_version }}/.openig/scripts/groovy/sf_RewritePath.groovy"
    owner: "{{ ig_owner }}"
    group: "{{ ig_group }}"
    mode: 0644
    remote_src: yes
    src: "{{ ig_code_location }}/sf_RewritePath.groovy"

